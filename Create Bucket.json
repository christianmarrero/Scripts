{"status":{},"contains_secrets":false,"product_version":"3.2.7","spec":{"description":"Create Bucket in Object Store","resources":{"client_attrs":{"525acce1_deployment":{"y":-58.509765625,"x":392.751953125}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9579588b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6e42d5bd_runbook","main_task_local_reference":{"kind":"app_task","name":"9579588b_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0047acd8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0a587d19_runbook","main_task_local_reference":{"kind":"app_task","name":"0047acd8_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3afdc2d8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ccadf66e_runbook","main_task_local_reference":{"kind":"app_task","name":"3afdc2d8_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a715fa0e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e1f4b87a_runbook","main_task_local_reference":{"kind":"app_task","name":"a715fa0e_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"35f63e0e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"aaec48e9_runbook","main_task_local_reference":{"kind":"app_task","name":"35f63e0e_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service1","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"EXISTING_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":true},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"localhost"},"variable_list":[]}],"credential_definition_list":[{"username":"mathurin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"PC_Creds"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service1"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Bucket"},{"kind":"app_task","name":"Sleep for 5 seconds"},{"kind":"app_task","name":"Check Bucket Creation Status"},{"kind":"app_task","name":"Assign Users to Bucket"}],"name":"d57153b3_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Create Bucket"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Sleep for 5 seconds"}},{"from_task_reference":{"kind":"app_task","name":"Sleep for 5 seconds"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Check Bucket Creation Status"}},{"from_task_reference":{"kind":"app_task","name":"Check Bucket Creation Status"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Assign Users to Bucket"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Bucket","attrs":{"script":"ip = \"@@{PC_IP}@@\"\nuser = \"@@{PC_Creds.username}@@\"\npassword = \"@@{PC_Creds.secret}@@\"\n\nVERSIONING_FEATURE = \"VERSIONING\"\n\nobject_store_uuid = \"@@{object_store_uuid}@@\"\nbucket_name = \"@@{bucket_name}@@\"\nenable_versioning = \"@@{enable_versioning}@@\"\nconfigure_worm = \"@@{configure_worm}@@\"\n\nif \"@@{non_current_version_expiration}@@\" > 0:\n  non_current_version_expiration = @@{non_current_version_expiration}@@\n  expiration = @@{non_current_version_expiration}@@\nelse:\n  non_current_version_expiration = None #days\n  expiration = None #days\n\nbase_url = \"https:\/\/\" + ip + \":9440\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"POST\"\n\n\ncreate_path = \"\/oss\/api\/nutanix\/v3\/objectstores\/{}\/buckets\".format(object_store_uuid)\nurl = base_url + create_path\n\ncreate_payload = {\n  \"api_version\": \"3.0\",\n  \"metadata\": {\n    \"kind\": \"bucket\"\n  },\n  \"spec\": {\n    \"description\": \"\",\n    \"name\": bucket_name,\n    \"resources\": {\n      \"features\": [\n      ]\n    }\n  }\n}\n\nif enable_versioning:\n  create_payload[\"spec\"][\"resources\"][\"features\"].append(VERSIONING_FEATURE)\n\nif non_current_version_expiration or expiration:\n  create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"] = {\n    \"Rule\": [\n    {\n      \"Filter\": {\n      },\n      \"ID\": \"ntnx-frontend-emptyprefix-rule\",\n      \"Status\": \"Enabled\"\n    }\n    ]\n  }\n\nif non_current_version_expiration:\n  create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"][\"Rule\"][0][\"NoncurrentVersionExpiration\"] = {\"NoncurrentDays\": non_current_version_expiration}\n\nif expiration:\n  create_payload[\"spec\"][\"resources\"][\"lifecycle_configuration\"][\"Rule\"][0][\"Expiration\"] = {\"Days\": expiration}\n\n    \nr = urlreq(url, url_method, auth=\"BASIC\", user=user, passwd=password, params=json.dumps(create_payload), verify=False, headers=headers)\n\nif r.ok:\n  print \"Bucket Creation in Progress\", json.dumps(json.loads(r.content), indent=4)\n  exit(0)\n\n  # If the call failed\nelse:\n  print \"Bucket Creation Failed\", json.dumps(json.loads(r.content), indent=4)\n  exit(1)\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep for 5 seconds","attrs":{"type":"","interval_secs":15},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Check Bucket Creation Status","attrs":{"script":"ip = \"@@{PC_IP}@@\"\nuser = \"@@{PC_Creds.username}@@\"\npassword = \"@@{PC_Creds.secret}@@\"\nobject_store_uuid = \"@@{object_store_uuid}@@\"\n\nbucket_name = \"@@{bucket_name}@@\"\nstatus_path = \"\/oss\/api\/nutanix\/v3\/objectstores\/{}\/buckets\/{}\".format(object_store_uuid, bucket_name)\n\nbase_url = \"https:\/\/\" + ip + \":9440\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"GET\"\n\nurl = base_url + status_path\n\nbucket_create_pending = True\n\npayload = {}\nwhile bucket_create_pending:\n\n  r = urlreq(url, url_method, auth=\"BASIC\", user=user, passwd=password, params=json.dumps(payload), verify=False, headers=headers)\n  if r.ok:\n    json_resp = r.json()\n    if json_resp[\"status\"][\"state\"] == 'COMPLETE':\n      bucket_create_pending = False\n      print(\"Bucket '{}' creation is Completed.\".format(bucket_name))\n      break\n    else:\n      print(\"Bucket creation '{}' is in '{}' state.\".format(bucket_name, json_resp[\"status\"][\"state\"]))\n      time.sleep(30)\n  else:\n    print \"Failure in getting bucket creation state\"\n    print \"Status Code: {0} Response: {1}\".format(r.status_code, r.text) \n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Assign Users to Bucket","attrs":{"script":"# Set creds, headers, and payload\nuser = '@@{PC_Creds.username}@@'\npassword = '@@{PC_Creds.secret}@@'\nip = \"@@{PC_IP}@@\"\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\n\nuser_list = []\nusers = \"@@{object_users}@@\"\nselected_users = users.split(\",\")\nprint selected_users\n\ndef getUserJSON(user_name):\n  user = {\n    \"username\": user_name,\n    \"permissions\": [\n        \"READ\",\n        \"WRITE\"\n      ]\n  }\n  return user\n  \nfor selected_user in selected_users:\n    user_list.append(getUserJSON(selected_user))\n    print \"Selected User: {}\".format(selected_user)\n  \n\npayload = {\n  \"name\": \"@@{bucket_name}@@\",\n  \"bucket_permissions\": user_list\n}\n\n\nprint payload\n# Set the url and make the call\nurl = \"https:\/\/\" + ip + \":9440\/oss\/api\/nutanix\/v3\/objectstores\/@@{object_store_uuid}@@\/buckets\/@@{bucket_name}@@\/share\"\nresp = urlreq(url, verb='PUT', auth='BASIC', user=user, passwd=password, params=json.dumps(payload), headers=headers, verify=False)\n\n# If the call went through successfully\nif resp.ok:\n  print(\"User @@{object_users}@@ added to bucket '@@{bucket_name}@@' successfully.\")\n\n# If the call failed\nelse:\n  print(url + \" call failed.\")\n  print(resp)\n  exit(1)","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"f6910f57_runbook","main_task_local_reference":{"kind":"app_task","name":"d57153b3_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"51db2097_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3800c7af_runbook","main_task_local_reference":{"kind":"app_task","name":"51db2097_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"525acce1_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"environment_reference_list":[],"description":"","action_list":[],"name":"NewBucket","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PC_IP","value":"10.42.54.39","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"non_current_version_expiration","value":"0","label":"Please select expiry of objects (no of days)","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"LIST","type":"LOCAL","name":"configure_worm","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["True","False"]}},{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":true,"description":"Objects in WORM buckets cannot be modified or deleted for the specific time period.","data_type":"LIST","type":"LOCAL","name":"enable_versioning","value":"","label":"Please select enable versioning of objects","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["True","False"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"bucket_name","value":"bucket","label":"Please key in the bucket name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"object_store_uuid","value":"be4b5eee-5b3b-4bce-7062-145e03bf71ab","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"LIST","type":"EXEC_LOCAL","name":"object_users","value":"","label":"Please select the users for the bucket","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"user = \"mkasten@epslab.local\"\npassword = \"SpringLily2021\"\nip = \"@@{PC_IP}@@\"\n\npayload = {\n \n}\n\nbase_url = \"https:\/\/\" + ip + \":9440\/oss\/iam_proxy\/users\"\nurl = base_url\n#print url\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\nurl_method = \"GET\"\nr = urlreq(url, url_method, auth=\"BASIC\", user=user, passwd=password, params=json.dumps(payload), verify=False, headers=headers)\n\nif r.ok:\n  user_list_json = r.json()\n  user_list = []\n  for user in user_list_json['users']:\n    user_list.append(user['username'])\n  print ','.join(user_list)    \nelse:\n  print \"Response Status: \" + str(r.status_code)\n  print r.text\n","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"PC_Creds"},"type":"USER"},"name":"Create Bucket"},"api_version":"3.0","metadata":{"last_update_time":"1635271958111306","kind":"blueprint","spec_version":9,"creation_time":"1634616099665835","name":"Create Bucket"}}